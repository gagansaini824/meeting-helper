<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Meeting Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1c1c1f;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --border: #27272a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-top: 2rem;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .glass {
            background: rgba(20, 20, 22, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Floating Overlay */
        .overlay {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 600px;
            max-height: 85vh;
            background: rgba(20, 20, 22, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 0 40px var(--accent-glow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .overlay.minimized {
            width: auto;
            height: auto;
            max-height: none;
        }
        
        .overlay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .mic-indicator {
            position: relative;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background: var(--bg-tertiary);
        }
        
        .mic-indicator.active {
            background: rgba(34, 197, 94, 0.2);
        }
        
        .mic-indicator.active::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0.75rem;
            background: rgba(34, 197, 94, 0.3);
            animation: pulse 2s ease-out infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .live-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .header-info h3 {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .header-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .icon-btn {
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .icon-btn.active {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
        }
        
        /* Content sections */
        .overlay-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .questions-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #questionsList {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.625rem;
            font-weight: 500;
            color: var(--warning);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }

        .question-card {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .question-card:hover {
            background: rgba(245, 158, 11, 0.15);
        }

        .question-text {
            font-size: 0.8125rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.6875rem;
            color: rgba(245, 158, 11, 0.7);
        }
        
        .speaker-badge {
            padding: 0.125rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 500;
        }
        
        .speaker-0 { border-left: 2px solid #6366f1; }
        .speaker-1 { border-left: 2px solid #22c55e; }
        .speaker-2 { border-left: 2px solid #f59e0b; }
        .speaker-3 { border-left: 2px solid #ef4444; }
        
        .suggestions-section .section-label {
            color: var(--text-secondary);
        }

        .suggestion-card {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-card:hover {
            background: #252528;
        }

        .suggestion-card .question-text {
            font-size: 0.8125rem;
        }

        .suggestion-type {
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }
        
        .type-clarification { color: #60a5fa; }
        .type-context { color: #a78bfa; }
        .type-insight { color: #fbbf24; }
        .type-action { color: #34d399; }

        /* Manual Question Input */
        .question-input-container {
            padding: 0;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .question-input-toggle {
            width: 100%;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .question-input-toggle:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .question-input-box {
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem 1rem 1rem;
        }

        .question-input-box.hidden {
            display: none;
        }

        .question-input-box input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.875rem;
        }

        .question-input-box input::placeholder {
            color: var(--text-secondary);
        }

        .question-input-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .question-input-box button {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .question-input-box button:hover {
            background: #5558e3;
        }

        .question-input-box button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        
        /* Answer panel */
        .answer-panel {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .answer-panel.collapsed .answer-text {
            display: none;
        }

        .answer-panel.collapsed {
            padding: 0.75rem 1rem;
        }

        .answer-panel.collapsed #collapseIcon {
            transform: rotate(-90deg);
        }

        #collapseIcon {
            transition: transform 0.3s ease;
        }
        
        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .answer-question {
            font-size: 0.6875rem;
            color: var(--accent);
            font-weight: 500;
        }

        .answer-text {
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .answer-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
        }

        .answer-panel.collapsed .answer-footer {
            display: none;
        }

        /* Markdown styling for answer text */
        .answer-text h1, .answer-text h2, .answer-text h3 {
            color: var(--text-primary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .answer-text h1 { font-size: 1.25rem; }
        .answer-text h2 { font-size: 1.1rem; }
        .answer-text h3 { font-size: 1rem; }

        .answer-text p {
            margin-bottom: 0.75rem;
        }

        .answer-text ul, .answer-text ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .answer-text li {
            margin-bottom: 0.25rem;
        }

        .answer-text strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .answer-text code {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
        }

        .answer-text pre {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 0.75rem;
        }

        .answer-text pre code {
            background: none;
            padding: 0;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Transcript */
        .transcript-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.6875rem;
            color: var(--text-secondary);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .transcript-toggle:hover {
            color: var(--text-primary);
        }

        .transcript-box {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 0.5rem;
            max-height: 120px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .transcript-entry {
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }
        
        .interim {
            opacity: 0.5;
            font-style: italic;
        }
        
        /* Footer */
        .overlay-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .main-btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 0.75rem;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-start {
            background: var(--accent);
            color: white;
        }
        
        .btn-start:hover {
            background: #5558e3;
        }
        
        .btn-stop {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .btn-stop:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* Documents panel */
        .docs-panel {
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .docs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .docs-header span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .upload-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
        }
        
        .upload-btn:hover {
            color: #818cf8;
        }
        
        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .doc-name {
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .doc-delete {
            padding: 0.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .doc-delete:hover {
            color: var(--danger);
        }
        
        .empty-state {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 1rem;
        }
        
        /* Minimized state */
        .minimized-btn {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hidden { display: none; }
        
        /* SVG icons inline */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        
        .icon-sm {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .icon-xs {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* Responsive Design - Mobile First */

        /* Mobile devices (up to 480px) */
        @media screen and (max-width: 480px) {
            body {
                padding: 0;
            }

            .container {
                padding-top: 1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .subtitle {
                font-size: 0.875rem;
                margin-bottom: 1.5rem;
            }

            .glass {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .overlay {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                border: none;
            }

            .overlay.minimized {
                position: fixed;
                top: auto;
                bottom: 1rem;
                left: auto;
                right: 1rem;
                width: auto;
                height: auto;
                max-height: none;
                border-radius: 1rem;
                border: 1px solid var(--border);
            }

            .overlay-header {
                padding: 0.75rem;
                flex-shrink: 0;
            }

            .header-info h3 {
                font-size: 0.8125rem;
            }

            .header-info p {
                font-size: 0.6875rem;
            }

            .overlay-content {
                padding: 0.75rem;
                flex: 1;
                overflow-y: auto;
            }

            .question-card,
            .suggestion-card {
                padding: 0.75rem;
            }

            .question-input-container {
                padding: 0.75rem;
            }

            .question-input-box input {
                padding: 0.625rem;
                font-size: 0.8125rem;
            }

            .question-input-box button {
                padding: 0.625rem 1rem;
                font-size: 0.8125rem;
            }

            .overlay-footer {
                padding: 0.75rem;
                padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
                flex-shrink: 0;
                background: var(--bg-secondary);
            }

            .main-btn {
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            .docs-panel {
                padding: 0.75rem;
                max-height: 150px;
                flex-shrink: 0;
            }

            .answer-panel {
                padding: 0.75rem;
            }

            .transcript-box {
                max-height: 100px;
            }

            #questionsList {
                max-height: 150px;
            }
        }

        /* Small tablets and large phones (481px - 768px) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            body {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .overlay {
                width: calc(100% - 2rem);
                max-width: 500px;
                bottom: 1rem;
                right: 1rem;
                max-height: 80vh;
            }
        }

        /* Tablets and small laptops (769px - 1024px) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .overlay {
                width: 500px;
                max-height: 85vh;
            }
        }

        /* Large screens (1025px and up) - default styles apply */
        @media screen and (min-width: 1025px) {
            .overlay {
                width: 600px;
            }
        }

        /* Handle very small screens */
        @media screen and (max-width: 320px) {
            body {
                padding: 0.75rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .glass {
                padding: 0.75rem;
            }

            .header-actions {
                gap: 0.25rem;
            }

            .icon-btn {
                padding: 0.375rem;
            }
        }

        /* Landscape mode on mobile */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .overlay {
                max-height: 90vh;
            }

            .container {
                display: none; /* Hide background content in landscape to give more space */
            }
        }

        /* Touch-friendly adjustments for mobile */
        @media (hover: none) and (pointer: coarse) {
            .question-card,
            .suggestion-card,
            .icon-btn,
            .main-btn {
                min-height: 44px; /* Apple's recommended minimum touch target */
            }

            .question-card:hover,
            .suggestion-card:hover {
                /* Disable hover effects on touch devices */
                background: inherit;
            }

            .question-card:active,
            .suggestion-card:active {
                background: rgba(245, 158, 11, 0.2);
            }

            .suggestion-card:active {
                background: #252528;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Meeting Assistant</h1>
        <p class="subtitle">
            AI-powered real-time meeting companion. Listens to conversations,
            detects questions instantly, and provides intelligent answers with
            speaker identification.
        </p>
        
        <div class="glass">
            <h2 style="font-size: 1.125rem; margin-bottom: 0.75rem;">How it works</h2>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
                <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: rgba(99, 102, 241, 0.2); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">1</span>
                    <span>Click "Start Listening" and allow microphone access</span>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: rgba(99, 102, 241, 0.2); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">2</span>
                    <span>Keep speakers on - the assistant hears and identifies speakers</span>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: rgba(99, 102, 241, 0.2); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">3</span>
                    <span>Questions are detected instantly with speaker labels</span>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                    <span style="width: 24px; height: 24px; border-radius: 50%; background: rgba(99, 102, 241, 0.2); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">4</span>
                    <span>Click any question for AI-powered answers with web search</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Overlay -->
    <div class="overlay" id="overlay">
        <div class="overlay-header">
            <div class="header-left">
                <div class="mic-indicator" id="micIndicator">
                    <svg class="icon" viewBox="0 0 24 24" id="micIcon">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="22"/>
                    </svg>
                    <div class="live-dot hidden" id="liveDot"></div>
                </div>
                <div class="header-info">
                    <h3>Meeting Assistant</h3>
                    <p id="statusText">Click to start</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="docsBtn" title="Documents">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                </button>
                <button class="icon-btn" id="minimizeBtn" title="Minimize">
                    <svg class="icon" viewBox="0 0 24 24">
                        <polyline points="4 14 10 14 10 20"/>
                        <polyline points="20 10 14 10 14 4"/>
                        <line x1="14" y1="10" x2="21" y2="3"/>
                        <line x1="3" y1="21" x2="10" y2="14"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Documents Panel -->
        <div class="docs-panel hidden" id="docsPanel">
            <div class="docs-header">
                <span>Documents (<span id="docCount">0</span>)</span>
                <label class="upload-btn">
                    <svg class="icon-sm" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                    <input type="file" id="fileInput" accept=".txt,.md,.json,.csv,.pdf,.docx,.doc,.xlsx,.xls,.png,.jpg,.jpeg,.gif,.webp" style="display: none;">
                </label>
            </div>
            <div id="docsList"></div>
        </div>
        
        <div class="overlay-content" id="overlayContent">
            <!-- Detected Questions -->
            <div class="questions-section" id="questionsSection">
                <div class="section-label">
                    <svg class="icon-sm" viewBox="0 0 24 24">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </svg>
                    LIVE QUESTION DETECTED
                </div>
                <div id="questionsList"></div>
            </div>
            
            <!-- AI Suggestions -->
            <div class="suggestions-section" id="suggestionsSection">
                <div class="section-label">
                    <svg class="icon-sm" viewBox="0 0 24 24">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    SUGGESTED TOPICS
                </div>
                <div id="suggestionsList"></div>
            </div>

            <!-- Manual Question Input -->
            <div class="question-input-container">
                <button class="question-input-toggle" id="questionInputToggle">
                    <svg class="icon-xs" viewBox="0 0 24 24" id="toggleChevron">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    Ask a question manually
                </button>
                <div class="question-input-box hidden" id="questionInputBox">
                    <input type="text" id="manualQuestionInput" placeholder="Type a question and press Enter or click Ask...">
                    <button id="askManualQuestion">Ask</button>
                </div>
            </div>

            <!-- Answer Panel -->
            <div class="answer-panel hidden" id="answerPanel">
                <div class="answer-header">
                    <div class="answer-question" id="answerQuestion"></div>
                </div>
                <div class="answer-text" id="answerText"></div>
                <div class="answer-footer">
                    <button class="icon-btn" id="collapseAnswer" title="Collapse answer">
                        <svg class="icon-sm" viewBox="0 0 24 24" id="collapseIcon">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <button class="icon-btn" id="closeAnswer" title="Close answer">
                        <svg class="icon-sm" viewBox="0 0 24 24">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Transcript -->
            <div class="transcript-section">
                <button class="transcript-toggle" id="transcriptToggle">
                    <svg class="icon-xs" viewBox="0 0 24 24" id="transcriptChevron">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                    Transcript
                </button>
                <div class="transcript-box hidden" id="transcriptBox"></div>
            </div>
        </div>
        
        <div class="overlay-footer">
            <button class="main-btn btn-start" id="mainBtn">Start Listening</button>
        </div>
    </div>

    <script>
        // State
        let isListening = false;
        let isMinimized = false;
        let showDocs = false;
        let showTranscript = false;
        let clientWs = null;
        let audioWs = null;
        let mediaRecorder = null;
        let audioContext = null;
        let documents = [];
        
        // DOM elements
        const overlay = document.getElementById('overlay');
        const micIndicator = document.getElementById('micIndicator');
        const liveDot = document.getElementById('liveDot');
        const statusText = document.getElementById('statusText');
        const mainBtn = document.getElementById('mainBtn');
        const docsBtn = document.getElementById('docsBtn');
        const minimizeBtn = document.getElementById('minimizeBtn');
        const docsPanel = document.getElementById('docsPanel');
        const docsList = document.getElementById('docsList');
        const docCount = document.getElementById('docCount');
        const fileInput = document.getElementById('fileInput');
        const questionsSection = document.getElementById('questionsSection');
        const questionsList = document.getElementById('questionsList');
        const suggestionsSection = document.getElementById('suggestionsSection');
        const suggestionsList = document.getElementById('suggestionsList');
        const answerPanel = document.getElementById('answerPanel');
        const answerQuestion = document.getElementById('answerQuestion');
        const answerText = document.getElementById('answerText');
        const closeAnswer = document.getElementById('closeAnswer');
        const collapseAnswer = document.getElementById('collapseAnswer');
        const transcriptToggle = document.getElementById('transcriptToggle');
        const transcriptBox = document.getElementById('transcriptBox');
        const overlayContent = document.getElementById('overlayContent');
        
        // WebSocket URL - use wss:// for HTTPS, ws:// for HTTP
        const WS_BASE = window.location.protocol === 'https:'
            ? `wss://${window.location.host}`
            : `ws://${window.location.host}`;
        
        // Connect to client WebSocket
        function connectClient() {
            clientWs = new WebSocket(`${WS_BASE}/ws/client`);
            
            clientWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
            
            clientWs.onclose = () => {
                setTimeout(connectClient, 2000);
            };
        }
        
        let currentAnswer = "";

        function handleMessage(msg) {
            console.log('Received message:', msg.type, msg);
            switch(msg.type) {
                case 'init':
                    renderTranscript(msg.data.transcript);
                    renderQuestions(msg.data.questions);
                    renderSuggestions(msg.data.suggestions);
                    break;

                case 'transcript':
                    appendTranscript(msg.data);
                    break;

                case 'question_detected':
                    addQuestion(msg.data);
                    break;

                case 'suggestions':
                    renderSuggestions(msg.data);
                    break;

                case 'answer_start':
                    // Clear previous answer and show loading
                    console.log('Answer starting for:', msg.data.question);
                    currentAnswer = "";
                    answerPanel.classList.remove('hidden');
                    answerPanel.classList.remove('collapsed');
                    answerText.innerHTML = '<div class="loading"><div class="spinner"></div>Generating answer...</div>';
                    break;

                case 'answer_chunk':
                    console.log('Answer chunk received:', msg.data.is_final ? 'FINAL' : 'partial', msg.data.chunk?.length || 0, 'chars');
                    if (!msg.data.is_final) {
                        // Append streaming chunk
                        currentAnswer += msg.data.chunk;
                        // Parse markdown and render as HTML
                        answerText.innerHTML = marked.parse(currentAnswer);
                    } else {
                        // Final chunk - use full answer if provided
                        console.log('Final answer received, length:', msg.data.full_answer?.length);
                        if (msg.data.full_answer) {
                            answerText.innerHTML = marked.parse(msg.data.full_answer);
                        }
                        // Show error if present
                        if (msg.data.error) {
                            console.error('Answer error:', msg.data.error);
                            answerText.innerHTML = `<div style="color: var(--danger);">Error: ${msg.data.error}</div>`;
                        }
                    }
                    break;

                case 'cleared':
                    clearUI();
                    break;
            }
        }
        
        // Audio streaming
        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                audioWs = new WebSocket(`${WS_BASE}/ws/audio`);
                
                audioWs.onopen = () => {
                    console.log('Audio WebSocket connected');
                };
                
                audioWs.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'ready') {
                        startRecording(stream);
                    }
                };
                
                audioWs.onerror = (error) => {
                    console.error('Audio WebSocket error:', error);
                    stopListening();
                };
                
                audioWs.onclose = () => {
                    console.log('Audio WebSocket closed');
                };
                
            } catch (error) {
                console.error('Failed to access microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }
        
        function startRecording(stream) {
            audioContext = new AudioContext({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(stream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            processor.onaudioprocess = (e) => {
                if (audioWs && audioWs.readyState === WebSocket.OPEN) {
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmData = new Int16Array(inputData.length);
                    
                    for (let i = 0; i < inputData.length; i++) {
                        pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                    }
                    
                    audioWs.send(pcmData.buffer);
                }
            };
            
            source.connect(processor);
            processor.connect(audioContext.destination);
            
            isListening = true;
            updateUI();
        }
        
        function stopListening() {
            if (audioWs) {
                audioWs.close();
                audioWs = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            isListening = false;
            updateUI();
        }
        
        function updateUI() {
            if (isListening) {
                micIndicator.classList.add('active');
                liveDot.classList.remove('hidden');
                statusText.textContent = 'Listening...';
                mainBtn.textContent = 'Stop Listening';
                mainBtn.classList.remove('btn-start');
                mainBtn.classList.add('btn-stop');
            } else {
                micIndicator.classList.remove('active');
                liveDot.classList.add('hidden');
                statusText.textContent = 'Click to start';
                mainBtn.textContent = 'Start Listening';
                mainBtn.classList.remove('btn-stop');
                mainBtn.classList.add('btn-start');
            }
        }
        
        // Transcript rendering
        function renderTranscript(entries) {
            transcriptBox.innerHTML = '';
            entries.forEach(entry => {
                appendTranscript({ speaker: entry.speaker, text: entry.text, is_final: true });
            });
        }
        
        function appendTranscript(data) {
            const existing = transcriptBox.querySelector('.interim');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.className = `transcript-entry speaker-${data.speaker % 4}`;
            if (!data.is_final) div.classList.add('interim');
            div.innerHTML = `<strong>Speaker ${data.speaker}:</strong> ${data.text}`;
            transcriptBox.appendChild(div);
            transcriptBox.scrollTop = transcriptBox.scrollHeight;
        }
        
        // Questions
        function renderQuestions(questions) {
            if (!questions || questions.length === 0) {
                questionsSection.classList.add('hidden');
                return;
            }

            questionsSection.classList.remove('hidden');
            questionsList.innerHTML = questions.map(q => `
                <div class="question-card" onclick="askQuestion('${escapeHtml(q.text)}')">
                    <div class="question-text">${escapeHtml(q.text)}</div>
                    <div class="question-meta">
                        <span class="speaker-badge">Speaker ${q.speaker}</span>
                        <span>Click for answer</span>
                    </div>
                </div>
            `).join('');
        }
        
        function addQuestion(q) {
            questionsSection.classList.remove('hidden');
            const card = document.createElement('div');
            card.className = 'question-card';
            card.onclick = () => askQuestion(q.text);
            card.innerHTML = `
                <div class="question-text">${escapeHtml(q.text)}</div>
                <div class="question-meta">
                    <span class="speaker-badge">Speaker ${q.speaker}</span>
                    <span>Click for answer</span>
                </div>
            `;
            // Add new questions at the bottom
            questionsList.appendChild(card);

            // Keep only 5, remove from top (oldest)
            while (questionsList.children.length > 5) {
                questionsList.removeChild(questionsList.firstChild);
            }
        }
        
        // Suggestions
        function renderSuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                suggestionsSection.classList.add('hidden');
                return;
            }
            
            suggestionsSection.classList.remove('hidden');
            suggestionsList.innerHTML = suggestions.map(s => `
                <div class="suggestion-card" onclick="askQuestion('${escapeHtml(s.question)}')">
                    <div class="question-text">${escapeHtml(s.question)}</div>
                    <div class="suggestion-type type-${s.type}">${s.type}</div>
                </div>
            `).join('');
        }
        
        // Answer
        function askQuestion(question) {
            console.log('askQuestion called with:', question);
            console.log('WebSocket state:', clientWs?.readyState, 'OPEN is', WebSocket.OPEN);

            currentAnswer = "";  // Reset answer for streaming
            answerPanel.classList.remove('hidden');
            answerQuestion.textContent = 'Q: ' + question;
            answerText.innerHTML = '<div class="loading"><div class="spinner"></div>Searching and analyzing...</div>';

            if (clientWs && clientWs.readyState === WebSocket.OPEN) {
                console.log('Sending get_answer request...');
                clientWs.send(JSON.stringify({ type: 'get_answer', question }));
            } else {
                console.error('WebSocket not connected!');
                answerText.innerHTML = '<div style="color: var(--danger);">WebSocket not connected. Please refresh the page.</div>';
            }
        }
        
        function showAnswer(question, answer) {
            answerQuestion.textContent = 'Q: ' + question;
            answerText.textContent = answer;
        }
        
        closeAnswer.onclick = () => {
            answerPanel.classList.add('hidden');
        };

        collapseAnswer.onclick = () => {
            answerPanel.classList.toggle('collapsed');
        };

        // Manual question input
        const manualQuestionInput = document.getElementById('manualQuestionInput');
        const askManualQuestionBtn = document.getElementById('askManualQuestion');
        const questionInputToggle = document.getElementById('questionInputToggle');
        const questionInputBox = document.getElementById('questionInputBox');
        const toggleChevron = document.getElementById('toggleChevron');
        let questionInputVisible = false;

        questionInputToggle.onclick = () => {
            questionInputVisible = !questionInputVisible;
            questionInputBox.classList.toggle('hidden', !questionInputVisible);

            if (questionInputVisible) {
                toggleChevron.innerHTML = '<polyline points="6 9 12 15 18 9"/>';
                manualQuestionInput.focus();
            } else {
                toggleChevron.innerHTML = '<polyline points="9 18 15 12 9 6"/>';
            }
        };

        function submitManualQuestion() {
            const question = manualQuestionInput.value.trim();
            if (question) {
                askQuestion(question);
                manualQuestionInput.value = '';
            }
        }

        askManualQuestionBtn.onclick = submitManualQuestion;

        manualQuestionInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                submitManualQuestion();
            }
        };
        
        // Documents
        async function loadDocuments() {
            try {
                const res = await fetch('/api/documents');
                const data = await res.json();
                documents = data.documents || [];
                renderDocuments();
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }
        
        function renderDocuments() {
            docCount.textContent = documents.length;
            
            if (documents.length === 0) {
                docsList.innerHTML = '<div class="empty-state">No documents uploaded</div>';
                return;
            }
            
            docsList.innerHTML = documents.map(d => `
                <div class="doc-item">
                    <span class="doc-name">${escapeHtml(d.name)}</span>
                    <button class="doc-delete" onclick="deleteDocument('${d.id}')">
                        <svg class="icon-sm" viewBox="0 0 24 24">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        async function uploadDocument(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', file.name);
            
            try {
                await fetch('/api/documents', { method: 'POST', body: formData });
                await loadDocuments();
            } catch (error) {
                console.error('Upload failed:', error);
            }
        }
        
        async function deleteDocument(id) {
            try {
                await fetch(`/api/documents/${id}`, { method: 'DELETE' });
                await loadDocuments();
            } catch (error) {
                console.error('Delete failed:', error);
            }
        }
        
        function clearUI() {
            questionsList.innerHTML = '';
            suggestionsList.innerHTML = '';
            transcriptBox.innerHTML = '';
            questionsSection.classList.add('hidden');
            suggestionsSection.classList.add('hidden');
            answerPanel.classList.add('hidden');
        }
        
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }
        
        // Event listeners
        mainBtn.onclick = () => {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        };
        
        docsBtn.onclick = () => {
            showDocs = !showDocs;
            docsPanel.classList.toggle('hidden', !showDocs);
            docsBtn.classList.toggle('active', showDocs);
        };
        
        minimizeBtn.onclick = () => {
            isMinimized = !isMinimized;
            if (isMinimized) {
                overlay.innerHTML = `
                    <button class="minimized-btn" onclick="restore()">
                        <div class="mic-indicator ${isListening ? 'active' : ''}">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="22"/>
                            </svg>
                            ${isListening ? '<div class="live-dot"></div>' : ''}
                        </div>
                    </button>
                `;
                overlay.classList.add('minimized');
            }
        };
        
        window.restore = () => {
            location.reload(); // Simple restore
        };
        
        transcriptToggle.onclick = () => {
            showTranscript = !showTranscript;
            transcriptBox.classList.toggle('hidden', !showTranscript);
        };
        
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) uploadDocument(file);
            e.target.value = '';
        };
        
        // Initialize
        connectClient();
        loadDocuments();
    </script>
</body>
</html>
